name: Deploy to Production (Websupport)

on:
  push:
    branches:
      - master

jobs:
  deploy:
    name: Deploy to Production Server
    # BeÅ¾Ã­ na Å¡tandardnom virtuÃ¡lnom stroji od GitHubu
    runs-on: ubuntu-latest

    steps:
      - name: Execute deployment script on server
        # PouÅ¾ijeme overenÃº akciu z komunity na SSH pripojenie
        uses: appleboy/ssh-action@master
        with:
          # NaÄÃ­tame naÅ¡e tajomstvÃ¡, ktorÃ© sme bezpeÄne uloÅ¾ili v nastaveniach repozitÃ¡ra
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}

          # Skript, ktorÃ½ sa postupne vykonÃ¡ na tvojom Websupport serveri
          script: |
            # Prejdi do prieÄinka s projektom
            cd ~/rucki.sk/rucki-web/

            # Vypni maintenance mode pre prÃ­pad, Å¾e by minulÃ½ deployment zlyhal
            # '|| true' zabezpeÄÃ­, Å¾e skript nespadne, ak strÃ¡nka nie je v maintenance mode
            php artisan up || true

            # Stiahni najnovÅ¡ie zmeny z GitHubu
            echo "ğŸšš Pulling latest changes from GitHub..."
            git pull origin master

            # NainÅ¡taluj/aktualizuj PHP zÃ¡vislosti bez interakcie
            echo "ğŸ“¦ Installing Composer dependencies..."
            composer install --no-interaction --prefer-dist --optimize-autoloader --no-dev

            # Spusti databÃ¡zovÃ© migrÃ¡cie.
            # POZOR: Pri deÅ¡truktÃ­vnych migrÃ¡ciÃ¡ch (mazanie/zmena stÄºpca) tento riadok doÄasne zakomentuj v kÃ³de pred vytvorenÃ­m PR!
            echo "ğŸ—„ï¸ Running database migrations..."
            php artisan migrate --force

            # VyÄisti a znovu naÄÃ­taj cache pre maximÃ¡lny vÃ½kon a prejavenie zmien
            echo "ğŸ§¹ Clearing application caches..."
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache

            echo "âœ… Deployment was successfully completed!"
